# ğŸ“‹ Models Spec Review Report

**Date:** 2024-12-27
**File reviewed:** `docs/synkao-models-spec.md` (v1.1)
**Session type:** Brainstorm & Review

---

## 1. TÃ³m táº¯t thay Ä‘á»•i v1.1

- Bá» Fulfillment entities (Fulfiller, Fulfillment, FulfillmentItem)
- Tracking info lÆ°u trá»±c tiáº¿p trong Order
- ÄÆ¡n giáº£n hÃ³a tá»« ~15 entities xuá»‘ng cÃ²n 12 entities

**ÄÃ¡nh giÃ¡:** âœ… ÄÃºng hÆ°á»›ng KISS/YAGNI cho MVP

---

## 2. Äiá»ƒm máº¡nh

| # | Aspect | ÄÃ¡nh giÃ¡ |
|---|--------|----------|
| 1 | State machines | RÃµ rÃ ng, transition rules chi tiáº¿t |
| 2 | Permission matrix | PhÃ¢n quyá»n owner/staff/designer há»£p lÃ½ |
| 3 | Index strategy | ÄÃ£ plan composite indexes cho common queries |
| 4 | Value objects | Money, Address Ä‘Æ°á»£c tÃ¡ch riÃªng |
| 5 | Enum definitions | Äáº§y Ä‘á»§, cÃ³ color mapping |

---

## 3. Thay Ä‘á»•i cáº§n thá»±c hiá»‡n

### 3.1 ğŸ”´ Priority High

#### A. TaskAssignment Entity (Multi-Assignee)

**Váº¥n Ä‘á»:** Hiá»‡n táº¡i chá»‰ cÃ³ 1 assignee per task

```go
// Current
AssigneeID *string // Chá»‰ 1 ngÆ°á»i
```

**Giáº£i phÃ¡p:** ThÃªm junction table

```go
type TaskAssignment struct {
    ID          string    `json:"id"`
    TaskID      string    `json:"task_id"`       // FK â†’ DesignTask
    UserID      string    `json:"user_id"`       // FK â†’ User
    Role        string    `json:"role"`          // "primary", "support"
    AssignedBy  string    `json:"assigned_by"`
    AssignedAt  time.Time `json:"assigned_at"`
}
```

**Index:**
```sql
CREATE UNIQUE INDEX idx_task_assignment_unique
ON task_assignments(task_id, user_id);

CREATE INDEX idx_task_assignment_user
ON task_assignments(user_id, task_id);
```

---

#### B. StoreConfig Encryption

**Váº¥n Ä‘á»:** Credentials lÆ°u plaintext trong JSON

```go
WooConsumerSecret string // âš ï¸ Security risk
ShopifyAPISecret  string // âš ï¸ Security risk
```

**Giáº£i phÃ¡p options:**
1. Encrypt at application level (AES-256)
2. Use external secret manager (Vault, AWS Secrets Manager)
3. Store encrypted, decrypt on read

---

### 3.2 ğŸŸ¡ Priority Medium

#### C. Optimistic Locking

**Váº¥n Ä‘á»:** Kanban drag-drop cÃ³ thá»ƒ conflict

**Giáº£i phÃ¡p:** ThÃªm version field

```go
type DesignTask struct {
    // ...existing fields...
    Version int `json:"version"` // Increment on each update
}
```

**Validation:**
```sql
UPDATE design_tasks
SET position = $1, version = version + 1
WHERE id = $2 AND version = $3
-- If rows affected = 0 â†’ conflict, return error
```

---

### 3.3 ğŸŸ¢ Priority Low

#### D. Bá» bidirectional FK

**Hiá»‡n táº¡i:**
```go
// OrderItem
DesignTaskID *string  // FK â†’ DesignTask â† Bá»

// DesignTask
OrderItemID string    // FK â†’ OrderItem â† GIá»®
```

**LÃ½ do:** Chá»‰ cáº§n 1 chiá»u, query ngÆ°á»£c qua JOIN

---

#### E. Soft Delete Strategy

**Äá» xuáº¥t:** ThÃªm `DeletedAt` cho:
- Order (giá»¯ history)
- DesignTask (audit trail)
- Design (version history Ä‘Ã£ cÃ³, khÃ´ng cáº§n)

---

### 3.4 âšª Future (Post-MVP)

#### F. ProductExternalID Integration

Khi integrate vá»›i há»‡ thá»‘ng PIM bÃªn thá»© 3:

```go
type OrderItem struct {
    // ...existing...
    ProductExternalID string `json:"product_external_id"` // Link to PIM
}

type DesignTask struct {
    // ...existing...
    ProductExternalID string `json:"product_external_id"` // Link to PIM
}
```

**Relationship má»›i:**
```
OrderItem â”€â”€â”¬â”€â”€â–¶ ProductExternalID â—€â”€â”€â”¬â”€â”€ DesignTask
            â”‚                         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€ (same product) â”€â”€â”˜
```

---

## 4. Quyáº¿t Ä‘á»‹nh Ä‘Ã£ thá»‘ng nháº¥t

| Topic | Decision | Rationale |
|-------|----------|-----------|
| Multi-assignee | Junction table | Flexibility, track history |
| Versioning | Auto-increment | Má»—i upload = version má»›i |
| Conflict | Optimistic locking | Prevent data loss |
| FK direction | Task â†’ Item only | Simpler, one source of truth |
| Product link | Future (PIM) | ChÆ°a cáº§n cho MVP |
| Tags/Attrs | Free-form | User tá»± Ä‘á»‹nh nghÄ©a |
| Design reuse | Flexible | CÃ³ thá»ƒ reuse hoáº·c táº¡o má»›i |

---

## 5. Entity Count Summary

| Before (v1.0) | After (v1.1) | After Review |
|---------------|--------------|--------------|
| ~15 entities | 12 entities | 13 entities (+TaskAssignment) |

---

## 6. Action Items

- [ ] Cáº­p nháº­t `docs/synkao-models-spec.md` vá»›i cÃ¡c thay Ä‘á»•i trÃªn
- [ ] Táº¡o GitHub issue cho TaskAssignment implementation
- [ ] Táº¡o GitHub issue cho StoreConfig encryption
- [ ] Review láº¡i khi integrate PIM system

---

## 7. Unresolved Questions

1. **Soft delete scope:** CÃ³ cáº§n soft delete cho User/Store khÃ´ng?
2. **Design reuse UX:** Khi reuse design, UI flow nhÆ° tháº¿ nÃ o?
3. **Version conflict UX:** Khi optimistic lock fail, hiá»ƒn thá»‹ gÃ¬ cho user?

---

*Report generated by Brainstormer Agent*
*Synkao Order Management System*
